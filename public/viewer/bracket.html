<!DOCTYPE html>
<html lang="ja">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GKJQRG9G0Q"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-GKJQRG9G0Q');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>決勝トーナメント - 大学杯</title>
    <link rel="icon" href="../icons/favicon.ico">

    <meta name="description" content="現在開催している大会の決勝トーナメント表です。大学杯は、大学生による大学生のためのスプラトゥーンのコミュニティ大会です。">
    <meta name="keywords" content="スプラ, スプラトゥーン, スプラ3, スプラトゥーン3, 大学杯, 大会, トーナメント表 ,e-sports">

    <meta property="og:title" content="決勝トーナメント - 大学杯">
    <meta property="og:description" content="現在開催している大会の決勝トーナメント表です。大学杯は、大学生による大学生のためのスプラトゥーンのコミュニティ大会です。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://daigakuhai.pages.dev/">
    <meta name="twitter:card" content="summary">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Zen+Kaku+Gothic+New:wght@500;700;900&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />

    <style>
        /* --- テーマ定義 --- */
        :root {
            --color-main: #374151;
            --color-bg: #F3F4F6;
            --color-panel: #FFFFFF;
            --color-shadow: #D1D5DB;

            /* Match Colors */
            --color-alpha: #d0be08;
            --color-bravo: #3a0ccd;
            --color-live-bg: #EF4444;
            --color-live-text: #FFFFFF;
            --color-live-inactive: #6B7280;

            /* Modal & Team Card Colors */
            --color-alpha-light: #FEFCE8;
            --color-bravo-light: #EFF6FF;
        }

        /* --- レイアウト基盤 --- */
        html { height: 100%; overflow: hidden; }

        body {
            font-family: 'Zen Kaku Gothic New', 'Kosugi Maru', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-main);
            position: fixed; inset: 0; width: 100%; height: 100%;
            overflow: hidden; overscroll-behavior: none;
            display: flex; justify-content: center;
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .pt-safe { padding-top: env(safe-area-inset-top, 0px); }

        #app-container {
            width: 100%; display: flex; flex-direction: column; height: 100%; position: relative;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 48;
            font-size: 24px;
        }

        /* --- ヘッダー --- */
        header { z-index: 50; position: relative; width: 100%; }

        .header-inner {
            width: 100%; max-width: 1080px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; height: 4rem; position: relative;
        }

        .header-icon-btn {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--color-main); background: #fff; color: var(--color-main);
            transition: all 0.2s; border-radius: 0.5rem; cursor: pointer;
            box-shadow: 2px 2px 0 0 var(--color-shadow);
        }
        .header-icon-btn:hover {
            background: var(--color-main); color: #fff;
            transform: translate(-1px, -1px); box-shadow: 3px 3px 0 0 var(--color-shadow);
        }
        .header-icon-btn:hover svg { fill: #fff; }
        .header-icon-btn:active { transform: translate(0, 0); box-shadow: none; }

        /* --- メインエリア --- */
        .main-container {
            flex: 1; position: relative; overflow: hidden; width: 100%; display: flex; flex-direction: column;
        }

        /* --- 大会名カード --- */
        .tournament-name-card {
            background-color: white;
            border: 2px solid var(--color-main); border-radius: 0.75rem;
            box-shadow: 4px 4px 0 0 var(--color-shadow); padding: 0.75rem 1.5rem;
            margin: 1rem auto 0 auto; text-align: center; max-width: 90%;
            width: fit-content; z-index: 10; flex-shrink: 0; transition: opacity 0.3s;
        }
        .tournament-label {
            display: block; font-size: 0.7rem; font-weight: 800; color: #9CA3AF;
            letter-spacing: 0.1em; margin-bottom: 0.1rem;
        }
        .tournament-name-text {
            font-size: 1.25rem; font-weight: 900; color: var(--color-main); line-height: 1.2;
        }

        /* --- トーナメント表エリア --- */
        .bracket-container {
            flex: 1; width: 100%; overflow: auto; padding: 2rem;
            cursor: grab; user-select: none; 
            /* 修正箇所: justify-content: center と align-items: center を削除 */
            display: flex; 
        }
        
        .bracket-wrapper {
            /* margin: auto により、コンテンツが小さい時は中央、大きい時は左上から配置されます */
            display: flex; gap: 4rem; margin: auto; flex-shrink: 0;
        }

        .round-column {
            display: flex; flex-direction: column; justify-content: space-around;
            gap: 1.5rem; width: 320px; flex-shrink: 0;
        }

        .round-header {
            text-align: center; margin-bottom: 0.5rem; font-weight: 900;
            color: var(--color-main); font-size: 1rem;
            background: rgba(255, 255, 255, 0.9); border: 2px solid var(--color-main);
            box-shadow: 2px 2px 0 0 var(--color-shadow); padding: 0.4rem; border-radius: 0.5rem;
        }

        /* --- マッチカード --- */
        .match-card {
            background-color: #FFFFFF; border: 2px solid var(--color-main);
            border-radius: 0.75rem; box-shadow: 4px 4px 0 0 var(--color-shadow);
            padding: 0.75rem 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;
            position: relative; transition: transform 0.2s; margin: 0.5rem 0;
        }
        .match-card:hover { transform: translateY(-2px); box-shadow: 6px 6px 0 0 var(--color-shadow); z-index: 10; }

        .match-card.is-live-active {
            border-color: var(--color-live-bg); box-shadow: 4px 4px 0 0 rgba(239, 68, 68, 0.3); animation: pulse-border 2s infinite;
        }
        .match-card.is-live-inactive {
            border-color: var(--color-live-inactive); box-shadow: 4px 4px 0 0 rgba(107, 114, 128, 0.3);
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .match-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 4px; padding: 0 4px;
        }
        .header-badges { display: flex; gap: 4px; }
        .match-id {
            background: var(--color-main); color: white; font-size: 0.6rem;
            padding: 2px 6px; border-radius: 4px; font-weight: bold;
        }
        .bo-badge {
            background: #E5E7EB; color: #4B5563; font-size: 0.6rem;
            padding: 2px 6px; border-radius: 4px; font-weight: bold; border: 1px solid #D1D5DB;
        }
        
        .live-badge {
            padding: 2px 8px; border-radius: 9999px; font-size: 0.6rem; font-weight: 900;
            display: flex; align-items: center; gap: 4px;
        }
        .live-badge.active { background-color: var(--color-live-bg); color: white; }
        .live-badge.inactive { background-color: var(--color-live-inactive); color: white; opacity: 0.8; }

        .team-row {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem;
            border-radius: 0.375rem; background-color: #F9FAFB; transition: background-color 0.2s;
        }
        .team-row.winner { background-color: #FEF3C7; font-weight: bold; }
        .team-row.loser { opacity: 0.6; }
        
        .team-label { width: 4px; height: 24px; border-radius: 2px; flex-shrink: 0; }
        .label-alpha { background-color: var(--color-alpha); }
        .label-bravo { background-color: var(--color-bravo); }

        .team-name-display {
            flex: 1; font-size: 0.9rem; font-weight: 700; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; cursor: pointer;
            padding: 2px 4px; border-radius: 4px;
        }
        .team-name-display:hover { color: var(--color-main); background-color: #E5E7EB; text-decoration: underline; }
        .team-name-display.withdrawn { text-decoration: line-through; color: #9CA3AF; pointer-events: none; }
        .team-name-display.undecided { color: #9CA3AF; cursor: default; pointer-events: none; }
        .team-name-display.undecided:hover { background-color: transparent; text-decoration: none; }

        .score-display { width: 24px; text-align: center; font-weight: 900; font-size: 1.1rem; }
        .win-icon { width: 24px; text-align: center; color: #F59E0B; }
        .match-card::after {
            content: '→'; position: absolute; right: -36px; top: 50%; transform: translateY(-50%);
            color: #D1D5DB; font-weight: 900; font-size: 1.5rem; display: none;
        }
        .round-column:not(:last-child) .match-card::after { display: block; }

        /* --- メッセージ表示エリア (予選中・期間外共通) --- */
        .qualifying-message-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            padding: 2rem; color: #6B7280;
        }
        .qualifying-icon { font-size: 64px; margin-bottom: 1rem; color: #9CA3AF; }
        .qualifying-title { font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem; color: var(--color-main); }
        .qualifying-sub { font-size: 1rem; font-weight: 700; line-height: 1.5; }

        /* --- Modal Common --- */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        
        .modal-content-base {
            background: #FFFFFF; width: 95%; max-width: 600px; max-height: 90vh;
            border: 2px solid var(--color-main); border-radius: 1rem;
            box-shadow: 6px 6px 0 0 var(--color-shadow);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.show .modal-content-base { transform: scale(1); }

        .team-card-header-bar {
            height: 12px; width: 100%; border-bottom: 2px solid var(--color-main); flex-shrink: 0;
            background-color: var(--color-main);
        }
        .team-card-body { padding: 2rem; display: flex; flex-direction: column; overflow-y: auto; }

        /* --- Team Info Styles --- */
        .header-section { margin-bottom: 1.5rem; border-bottom: 2px solid #E5E7EB; padding-bottom: 1.5rem; }
        .univ-name {
            font-size: 1.8rem; font-weight: 800; color: #4B5563; line-height: 1.2;
            margin-bottom: 0.25rem; letter-spacing: 0.05em;
        }
        .team-kana { font-size: 1.1rem; font-weight: 700; color: #6B7280; margin-bottom: 0; line-height: 1.2; }
        .team-name-lg {
            font-size: 2.5rem; font-weight: 900; line-height: 1.1; color: var(--color-main);
            margin-bottom: 1rem; letter-spacing: -0.02em; margin-top: 0.25rem;
        }

        .circle-tag {
            display: inline-flex; align-items: center; background-color: #F9FAFB;
            border: 2px solid var(--color-main); border-radius: 0.75rem;
            padding: 0.4rem 1rem 0.4rem 0.5rem; cursor: pointer;
            box-shadow: 2px 2px 0 0 var(--color-shadow); transition: transform 0.1s;
        }
        .circle-tag:hover { transform: translateY(-1px); box-shadow: 3px 3px 0 0 var(--color-shadow); }
        .circle-icon { font-size: 24px; margin-right: 0.5rem; color: #6B7280; }
        .circle-text { font-weight: 700; font-size: 1.125rem; color: #374151; }

        .avg-xp-box {
            display: inline-block; background-color: white; color: var(--color-main);
            font-weight: 800; font-size: 1rem; padding: 0.25rem 1rem; border-radius: 9999px;
            box-shadow: 2px 2px 0 0 var(--color-shadow); margin-top: 0.5rem;
            border: 2px solid var(--color-main); margin-left: 0.5rem;
        }

        .member-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1rem; }
        .member-card {
            display: flex; align-items: center; padding: 0.75rem 1rem;
            background-color: white; border: 2px solid #E5E7EB; border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .name-group { flex: 1; display: flex; align-items: baseline; flex-wrap: wrap; gap: 0.5rem; }
        .member-name { font-size: 1.25rem; font-weight: 800; color: var(--color-main); line-height: 1; }
        .member-kana { font-size: 0.75rem; font-weight: 600; color: #9CA3AF; }
        .member-weapon {
            display: block; width: 100%; font-size: 0.85rem; font-weight: 600; color: #6B7280; margin-top: 0.25rem;
        }

        .info-separator { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .info-separator-line { flex: 1; height: 2px; background-color: #E5E7EB; }
        .info-separator-text {
            font-weight: 800; font-size: 1rem; color: #9CA3AF; background-color: #F3F4F6;
            padding: 0.25rem 1rem; border-radius: 9999px; letter-spacing: 0.1em;
        }

        .info-block {
            background-color: white; border: 2px solid #E5E7EB; border-radius: 0.75rem;
            padding: 1.25rem; margin-bottom: 1rem; position: relative;
        }
        .info-label {
            position: absolute; top: -12px; left: 1rem; background-color: #F3F4F6;
            color: #4B5563; font-weight: 700; font-size: 0.8rem; padding: 0.1rem 0.75rem;
            border-radius: 0.5rem; border: 2px solid #E5E7EB;
        }
        .info-content { font-weight: 500; font-size: 1rem; line-height: 1.7; white-space: pre-wrap; color: #4B5563; }

        .close-btn-area {
            padding: 1rem; background: #F9FAFB; border-top: 1px solid #E5E7EB;
            display: flex; justify-content: center; flex-shrink: 0;
        }
        .modal-close-btn {
            background: var(--color-main); color: white; font-weight: 800; padding: 0.5rem 2rem;
            border-radius: 9999px; box-shadow: 2px 2px 0 0 #9CA3AF; transition: all 0.1s;
        }
        .modal-close-btn:hover { transform: translateY(-1px); box-shadow: 3px 3px 0 0 #9CA3AF; }
        .modal-close-btn:active { transform: translateY(0); box-shadow: none; }

        /* --- Circle Modal Styles --- */
        .circle-modal-content {
            background: white; width: 90%; max-width: 600px;
            border: 2px solid var(--color-main); border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .circle-modal-header {
            padding: 1rem; border-bottom: 1px solid #E5E7EB; display: flex;
            justify-content: space-between; align-items: center; background-color: #F9FAFB;
        }
        .circle-modal-title { font-weight: 700; font-size: 1.25rem; color: #374151; display: flex; align-items: center; gap: 0.5rem; }
        .circle-modal-body { padding: 2rem; overflow-y: auto; }
        .circle-img-container {
            width: 8rem; height: 8rem; border-radius: 9999px; overflow: hidden;
            border: 2px solid #E5E7EB; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem; background-color: #F3F4F6; margin-left: auto; margin-right: auto;
        }
        .circle-univ-sub {
            font-size: 1rem; font-weight: 700; color: #6B7280; margin-bottom: 0.25rem;
            text-transform: uppercase; letter-spacing: 0.1em; text-align: center;
        }
        .circle-name-lg { font-size: 1.875rem; font-weight: 900; color: #1F2937; margin-bottom: 1.5rem; text-align: center; }
        
        .sns-tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
        .sns-tag-item {
            display: inline-flex; align-items: center; padding: 0.25rem 0.75rem;
            background-color: white; border: 1px solid #D1D5DB; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: 700; color: #4B5563; border-radius: 0.5rem; font-size: 0.875rem;
            text-decoration: none; transition: all 0.2s; cursor: pointer;
        }
        .sns-tag-item:hover {
            transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: var(--color-main); color: var(--color-main);
        }
        .circle-desc-box { background-color: #F9FAFB; border-radius: 0.5rem; padding: 1.5rem; border: 1px solid #E5E7EB; }
        .circle-desc-text { color: #374151; line-height: 1.625; white-space: pre-wrap; font-weight: 500; }
    </style>
</head>

<body>

    <div id="app-container">
        <header class="flex-shrink-0 bg-white border-b-2 border-gray-900 pt-safe z-50">
            <div class="header-inner">
                <a href="../index.html" class="header-icon-btn" title="ホームに戻る">
                    <span class="material-symbols-rounded">home</span>
                </a>

                <h1 class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 
                        text-lg md:text-xl font-black text-gray-900 tracking-tight whitespace-nowrap text-center">
                    決勝トーナメント
                </h1>

                <div class="flex gap-2">
                    <a href="https://x.com/daigakuhai" target="_blank" rel="noopener noreferrer" class="header-icon-btn"
                        title="X (@daigakuhai)">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="#1F2937">
                            <path
                                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
                            </path>
                        </svg>
                    </a>
                    <a href="https://www.youtube.com/@早稲田スプ研" target="_blank" rel="noopener noreferrer"
                        class="header-icon-btn" title="YouTube (@早稲田スプ研)">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#1F2937">
                            <path
                                d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                        </svg>
                    </a>
                </div>
            </div>
        </header>

        <main class="main-container">
            <div id="tournament-name-card" class="tournament-name-card opacity-0 hidden">
                <span class="tournament-label">CURRENT TOURNAMENT</span>
                <h2 id="tournament-name-display" class="tournament-name-text"></h2>
            </div>

            <div class="bracket-container">
                <div id="bracket-wrapper" class="bracket-wrapper">
                    <div class="flex items-center justify-center w-full h-32 text-gray-400 font-bold">
                        Loading tournament data...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="team-modal" class="modal-overlay" onclick="handleModalOutsideClick(event)">
        <div class="modal-content-base">
            <div class="team-card-header-bar" id="modal-color-bar"></div>
            <div class="team-card-body">
                <div class="header-section">
                    <h3 id="modal-univ" class="univ-name">-</h3>
                    <p id="modal-kana" class="team-kana"></p>
                    <h2 id="modal-team-name" class="team-name-lg">チーム名</h2>

                    <div class="flex flex-wrap items-center gap-2 mt-2">
                        <div id="modal-circle-container" class="circle-tag">
                            <span class="material-symbols-rounded circle-icon">diversity_3</span>
                            <span id="modal-circle" class="circle-text">-</span>
                        </div>
                        <div id="modal-xp-tag" class="avg-xp-box hidden">XP <span id="modal-xp-val"></span></div>
                    </div>
                </div>

                <div id="modal-members" class="member-grid"></div>

                <div class="info-separator">
                    <div class="info-separator-line"></div>
                    <div class="info-separator-text">TEAM INFO</div>
                    <div class="info-separator-line"></div>
                </div>

                <div id="modal-info-container"></div>
            </div>

            <div class="close-btn-area">
                <button class="modal-close-btn" onclick="closeTeamModal()">閉じる</button>
            </div>
        </div>
    </div>

    <div id="circle-modal" class="modal-overlay">
        <div class="circle-modal-content">
            <div class="circle-modal-header">
                <h3 class="circle-modal-title">
                    <span class="material-symbols-rounded">diversity_3</span> CIRCLE INFO
                </h3>
                <button onclick="closeCircleModal()"
                    class="p-2 hover:bg-gray-200 rounded-full text-gray-500 transition-all flex items-center justify-center">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="circle-modal-body">
                <div class="flex flex-col items-center text-center mb-8">
                    <div class="circle-img-container">
                        <img id="modal-circle-img" src="" alt="icon" class="w-full h-full object-cover"
                            onerror="this.src='data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'%23e5e7eb\' viewBox=\'0 0 24 24\'%3e%3cpath d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\'/%3e%3c/svg%3e'">
                    </div>
                    <p id="modal-circle-univ" class="circle-univ-sub">UNIVERSITY</p>
                    <h2 id="modal-circle-name" class="circle-name-lg">サークル名</h2>
                    <div class="sns-tags">
                        <a id="modal-circle-id" href="#" target="_blank" class="sns-tag-item hidden"></a>
                        <a id="modal-circle-win" href="#" target="_blank" class="sns-tag-item hidden"></a>
                    </div>
                </div>
                <div class="circle-desc-box">
                    <p id="modal-circle-comment" class="circle-desc-text"></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAotBKDxazOEtOv_IzoqW9bNPQXaz7a3vA",
            authDomain: "daigakuhai-support-fb.firebaseapp.com",
            projectId: "daigakuhai-support-fb",
            storageBucket: "daigakuhai-support-fb.firebasestorage.app",
            messagingSenderId: "939931798179",
            appId: "1:939931798179:web:8320fba89104e81f47cd16"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tournamentRef = doc(db, "state", "tournament");
        const settingsRef = doc(db, "state", "settings");

        let teamsMap = new Map();
        let circleData = [];
        let currentFormat = 8;
        let tournamentData = { matches: {}, roundNames: {} };
        let tournamentSettings = {
            matchFormat: { other: 'BO3', semis: 'BO5', finals: 'BO5' },
            startDate: null,
            startTime: null
        };

        const SEED_ID = "THE_SEED";
        const bracketWrapper = document.getElementById('bracket-wrapper');
        const nameDisplayEl = document.getElementById('tournament-name-display');
        const nameCardEl = document.getElementById('tournament-name-card');

        // Team Modal Elements
        const modalEl = document.getElementById('team-modal');
        const mEl = {
            bar: document.getElementById('modal-color-bar'),
            univ: document.getElementById('modal-univ'),
            kana: document.getElementById('modal-kana'),
            name: document.getElementById('modal-team-name'),
            circle: document.getElementById('modal-circle'),
            circleContainer: document.getElementById('modal-circle-container'),
            xpTag: document.getElementById('modal-xp-tag'),
            xpVal: document.getElementById('modal-xp-val'),
            members: document.getElementById('modal-members'),
            infoContainer: document.getElementById('modal-info-container')
        };

        // Circle Modal Elements
        const cModalEl = document.getElementById('circle-modal');
        const cmEl = {
            img: document.getElementById('modal-circle-img'),
            univ: document.getElementById('modal-circle-univ'),
            name: document.getElementById('modal-circle-name'),
            id: document.getElementById('modal-circle-id'),
            win: document.getElementById('modal-circle-win'),
            comment: document.getElementById('modal-circle-comment')
        };

        async function init() {
            await Promise.all([fetchTeams(), fetchCircles()]);
            setupFirestoreListeners();
            setupDragScroll();
        }

        async function fetchTeams() {
            try {
                const res = await fetch('../json/teams.json');
                const data = await res.json();
                data.forEach(t => teamsMap.set(t.id, t));
                teamsMap.set(SEED_ID, { id: SEED_ID, teamName: "シード", university: "-", circle: "-" });
            } catch (e) { console.error("Fetch teams error", e); }
        }

        async function fetchCircles() {
            try {
                const res = await fetch('../json/circle-info.json');
                if (res.ok) circleData = await res.json();
            } catch (e) { console.error("Fetch circles error", e); }
        }

        function setupFirestoreListeners() {
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    tournamentSettings = { ...tournamentSettings, ...data };

                    // Update Tournament Name Card (Text Only)
                    if (data.tournamentName) {
                        nameDisplayEl.textContent = data.tournamentName;
                        nameCardEl.classList.remove('opacity-0');
                    } else {
                        nameCardEl.classList.add('opacity-0');
                    }

                    if (tournamentData.matches) render();
                }
            });

            onSnapshot(tournamentRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    tournamentData = data;
                    if (!tournamentData.matches) tournamentData.matches = {};
                    if (tournamentData.format) currentFormat = parseInt(tournamentData.format);
                    render();
                }
            });
        }

        // --- Check if tournament is currently active based on Date/Time ---
        function checkTournamentActive() {
            // #debug hash skips time check
            if (window.location.hash === '#debug') return true;

            const { startDate, startTime } = tournamentSettings;
            
            if (!startDate || !startTime) return true; 

            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(start.getTime() + 12 * 60 * 60 * 1000); // +12 hours
            const now = new Date();

            return now >= start && now <= end;
        }

        function checkQualifyingStatus() {
            if (!currentFormat || !tournamentData.matches) return true;
            const matchCountR1 = currentFormat / 2;
            let isFilled = true;
            for (let m = 1; m <= matchCountR1; m++) {
                const matchId = `r1_m${m}`;
                const match = tournamentData.matches[matchId];
                if (!match || !match.alpha || !match.bravo) {
                    isFilled = false;
                    break;
                }
            }
            return !isFilled;
        }

        function render() {
            // 1. Check Time Validity
            const isActiveTime = checkTournamentActive();
            if (!isActiveTime) {
                renderOfflineScreen();
                return;
            }

            // 2. Check Qualifying Status
            if (checkQualifyingStatus()) {
                renderQualifyingScreen();
            } else {
                renderBracket();
            }
        }

        function renderOfflineScreen() {
            // 大会期間外：カード自体を非表示に
            nameCardEl.classList.add('hidden');

            bracketWrapper.innerHTML = `
                <div class="qualifying-message-container">
                    <span class="material-symbols-rounded qualifying-icon">event_busy</span>
                    <h2 class="qualifying-title">現在大会は行われていません</h2>
                    <p class="qualifying-sub">開催日時をご確認ください。<br>（大会開始〜12時間後まで表示されます）</p>
                </div>
            `;
        }

        function renderQualifyingScreen() {
            // 期間内：カードを表示
            nameCardEl.classList.remove('hidden');

            bracketWrapper.innerHTML = `
                <div class="qualifying-message-container">
                    <span class="material-symbols-rounded qualifying-icon">sports_esports</span>
                    <h2 class="qualifying-title">予選進行中</h2>
                    <p class="qualifying-sub">決勝トーナメントの組み合わせ決定まで<br>もうしばらくお待ちください</p>
                </div>
            `;
        }

        function checkActiveLive(matchId, roundNum) {
            const match = tournamentData.matches[matchId];
            if (!match || !match.isLive) return false;
            if (match.winner) return false;

            const hasTeams = match.alpha && match.bravo && match.alpha !== SEED_ID && match.bravo !== SEED_ID && !match.alphaWithdraw && !match.bravoWithdraw;
            if (!hasTeams) return false;

            for (let r = 1; r < roundNum; r++) {
                const matchCount = currentFormat / Math.pow(2, r);
                for (let m = 1; m <= matchCount; m++) {
                    const prevId = `r${r}_m${m}`;
                    const prevMatch = tournamentData.matches[prevId];
                    if (prevMatch && prevMatch.isLive && !prevMatch.winner) return false;
                }
            }
            return true;
        }

        function renderBracket() {
            // 期間内：カードを表示
            nameCardEl.classList.remove('hidden');

            bracketWrapper.innerHTML = '';
            const totalRounds = Math.log2(currentFormat);

            for (let r = 1; r <= totalRounds; r++) {
                const roundCol = document.createElement('div');
                roundCol.className = 'round-column';

                let defaultName = `ラウンド ${r}`;
                if (r === totalRounds) defaultName = "決勝";
                else if (r === totalRounds - 1) defaultName = "準決勝";

                const rName = tournamentData.roundNames && tournamentData.roundNames[r] ? tournamentData.roundNames[r] : defaultName;

                const header = document.createElement('div');
                header.className = 'round-header';
                header.textContent = rName;
                roundCol.appendChild(header);

                const matchCount = currentFormat / Math.pow(2, r);
                const boType = getRoundFormat(r, totalRounds);

                for (let m = 1; m <= matchCount; m++) {
                    const matchId = `r${r}_m${m}`;
                    const matchData = tournamentData.matches[matchId] || { alpha: null, bravo: null, scoreA: 0, scoreB: 0, winner: null, isLive: false };

                    const isActiveLive = checkActiveLive(matchId, r);
                    const isAnyLive = matchData.isLive === true;

                    const card = createMatchCard(matchId, matchData, boType, isAnyLive, isActiveLive);
                    roundCol.appendChild(card);
                }
                bracketWrapper.appendChild(roundCol);
            }
        }

        function createMatchCard(matchId, data, boType, isAnyLive, isActiveLive) {
            const div = document.createElement('div');
            let statusClass = '';
            if (isAnyLive) {
                statusClass = isActiveLive ? 'is-live-active' : 'is-live-inactive';
            }
            div.className = `match-card ${statusClass}`;

            const header = document.createElement('div');
            header.className = 'match-header';

            const badges = document.createElement('div');
            badges.className = 'header-badges';
            badges.innerHTML = `
                <span class="match-id">${matchId.toUpperCase().replace('_', '-')}</span>
                <span class="bo-badge">${boType}</span>
            `;
            header.appendChild(badges);

            if (isAnyLive) {
                const liveBadge = document.createElement('div');
                const badgeClass = isActiveLive ? 'live-badge active' : 'live-badge inactive';
                liveBadge.className = badgeClass;
                liveBadge.innerHTML = `<span class="material-symbols-rounded" style="font-size: 14px;">sensors</span>ON AIR`;
                header.appendChild(liveBadge);
            }

            div.appendChild(header);
            div.appendChild(createTeamRow('alpha', data));
            div.appendChild(createTeamRow('bravo', data));

            return div;
        }

        function createTeamRow(side, data) {
            const teamId = side === 'alpha' ? data.alpha : data.bravo;
            const score = side === 'alpha' ? data.scoreA : data.scoreB;
            const isWinner = data.winner === side;
            const isLoser = data.winner && data.winner !== side;
            const isWithdrawn = data[side + 'Withdraw'] === true;
            const isSeed = teamId === SEED_ID;

            const teamObj = teamsMap.get(teamId);
            const teamName = teamObj ? teamObj.teamName : "未決定";

            const row = document.createElement('div');
            row.className = `team-row ${isWinner ? 'winner' : (isLoser ? 'loser' : '')}`;

            let html = `<div class="team-label ${side === 'alpha' ? 'label-alpha' : 'label-bravo'}"></div>`;

            let nameClass = "team-name-display";
            if (!teamId) nameClass += " undecided";
            else if (isWithdrawn) nameClass += " withdrawn";

            const clickAttr = (teamId && !isSeed && !isWithdrawn) ? `onclick="openTeamModal('${teamId}')"` : "";

            html += `<div class="${nameClass}" ${clickAttr} title="${teamId ? 'クリックして詳細を表示' : ''}">${teamName}</div>`;

            if (!isSeed && !isWithdrawn && teamId) {
                if (isWinner) {
                    html += `<span class="material-symbols-rounded win-icon">emoji_events</span>`;
                    html += `<div class="score-display text-gray-800">${score}</div>`;
                } else {
                    html += `<div class="score-display text-gray-400">${score}</div>`;
                }
            }

            row.innerHTML = html;
            return row;
        }

        function getRoundFormat(roundNum, totalRounds) {
            const settings = tournamentSettings.matchFormat || { other: 'BO3', semis: 'BO5', finals: 'BO5' };
            if (roundNum === totalRounds) return settings.finals;
            if (roundNum === totalRounds - 1) return settings.semis;
            return settings.other;
        }

        function setupDragScroll() {
            const slider = document.querySelector('.bracket-container');
            let isDown = false;
            let startX, scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true; slider.classList.add('active');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
            slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); });
            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 1.5;
                slider.scrollLeft = scrollLeft - walk;
            });
        }

        // --- Team Modal Logic ---
        window.openTeamModal = (teamId) => {
            const team = teamsMap.get(teamId);
            if (!team || teamId === SEED_ID) return;
            const isValid = (txt) => txt && txt !== "----" && txt !== "";

            mEl.bar.style.backgroundColor = 'var(--color-main)';
            mEl.univ.textContent = team.university;
            mEl.kana.textContent = isValid(team.teamName_kana) ? team.teamName_kana : "";
            mEl.name.textContent = team.teamName;

            mEl.circle.textContent = team.circle;
            mEl.circleContainer.onclick = () => openCircleModal(team.circle);

            if (isValid(team.team_average_xp)) {
                mEl.xpVal.textContent = Math.floor(Number(team.team_average_xp));
                mEl.xpTag.classList.remove('hidden');
            } else {
                mEl.xpTag.classList.add('hidden');
            }

            mEl.members.innerHTML = '';
            for (let i = 1; i <= 4; i++) {
                const pName = team[`p${i}_name`];
                if (!isValid(pName)) continue;
                const pKana = team[`p${i}_name_kana`];
                const pWeapon = team[`p${i}_weapon`];

                const div = document.createElement('div');
                div.className = 'member-card';
                div.innerHTML = `
                    <div class="name-group">
                        <span class="member-name">${pName}</span>
                        ${isValid(pKana) ? `<span class="member-kana">${pKana}</span>` : ''}
                        <span class="member-weapon">${pWeapon || '-'}</span>
                    </div>
                `;
                mEl.members.appendChild(div);
            }

            let infoHtml = '';
            const appendInfo = (label, text) => {
                infoHtml += `<div class="info-block"><div class="info-label">${label}</div><p class="info-content">${text}</p></div>`;
            };

            if (isValid(team.comment)) appendInfo("意気込み", team.comment);
            if (isValid(team.records)) appendInfo("実績", team.records);
            if (isValid(team.message)) appendInfo("メッセージ", team.message);

            mEl.infoContainer.innerHTML = infoHtml;
            modalEl.classList.add('show');
        };

        window.closeTeamModal = () => modalEl.classList.remove('show');
        window.handleModalOutsideClick = (e) => { if (e.target === modalEl) closeTeamModal(); };


        // --- Circle Modal Logic ---
        window.openCircleModal = (circleName) => {
            const info = circleData.find(c => c['circleName'] === circleName) || circleData.find(c => c['circle_name'] === circleName);
            if (!info) return;

            cmEl.img.src = info['icon_url'] || '';
            cmEl.univ.textContent = info['university'] || 'UNIVERSITY';
            cmEl.name.textContent = info['circleName'] || circleName;
            cmEl.comment.textContent = info['description'] || '情報がありません';

            const twId = info['twitter'];
            if (twId && twId !== '-') {
                const cleanId = twId.replace(/^@/, '');
                cmEl.id.textContent = `@${cleanId}`;
                cmEl.id.href = `https://twitter.com/${cleanId}`;
                cmEl.id.classList.remove('hidden');
            } else {
                cmEl.id.classList.add('hidden');
            }

            const tag = info['hashtag'];
            if (tag && tag !== '-') {
                const rawTag = tag.replace('#', '');
                cmEl.win.textContent = `#${rawTag}`;
                cmEl.win.href = `https://twitter.com/intent/tweet?hashtags=${rawTag}`;
                cmEl.win.classList.remove('hidden');
            } else {
                cmEl.win.classList.add('hidden');
            }

            cModalEl.classList.add('show');
        };

        window.closeCircleModal = () => cModalEl.classList.remove('show');
        window.addEventListener('click', (e) => {
            if (e.target === cModalEl) closeCircleModal();
        });

        init();
    </script>
</body>

</html>